library(tidyverse)
library(tidyr)
library(ggplot2)
getVpd = function (temperature, rh) {
esat = eSat(temperature)
ea = ea(temperature, rh)
v = esat - ea
return(v)
}
celsiusToKelvin = function (temperature) {
return(temperature + 273.15)
}
eSat = function (temperature)
{
temperature = celsiusToKelvin(temperature)
eSat = 6.1078 * exp((17.2693882 * (temperature - 273.15))/(temperature -
35.86))
eSat = eSat * 100
return(eSat/1000)
}
ea = function (temperature, rh) {
esat = eSat(temperature)
ea = (rh * esat)/100
return(ea)
}
wd_txt <- "C:/Users/Vinicius/Desktop/data"
setwd(wd_txt)
getwd()
# Process data to range (um)
# assuming this datasheet https://www.midoriamerica.com/wp-content/uploads/2018/03/lpfbs3.pdf
totalTravel      = 20*1000 # 20mm travel
totalResistance  = 2000 # 2000 Ohm for 20mm travel
conversionFactor = totalTravel/totalResistance # um per Ohm; 1% linearity, so just assume change is equal across resistance
current = 3.300/2000 # current across the sensor is constant 3.3V/2000Ohm
# read table with the info of all trees connected to each port of each logger
logger_list <-
data.frame(id_logger = c("SN097", "SN098", "SN100", "SN102", "SN103"),
sen0_adc24 = c("CVAS11_bark", "CVAS10_bark", "CVCE04_bark", "CVCE02_bark", "CVAS13_bark"),
sen1_adc24 = c("CVAS11_xylem", "CVAS10_xylem", "CVCE04_xylem", "CVCE02_xylem", "CVAS13_xylem"),
sen2_adc24 = c("CVAS09_bark", "CVCE01_bark","CVCE03_bark", "CVCE07_bark", "CVAS12_bark"),
sen3_adc24 = c("CVAS09_xylem", "CVCE01_xylem","CVCE03_xylem", "CVCE07_xylem","CVAS12_xylem")) %>%
pivot_longer(-id_logger,
names_to = "id_port",
values_to = "tree_info",
values_drop_na = TRUE)
# Create file list of the data logger files (per logger + date)
df_files_ms <- data.frame(file_list = dir(path = "C:/Users/Vinicius/Desktop/data/morada/24-01/dendrometers")) %>%
mutate(file_path = paste("C:/Users/Vinicius/Desktop/data/morada/24-01/dendrometers", file_list, sep = "/"),
location = "Morada do Sol")
# Create file list of the data logger files (per logger + date)
df_files_ms <- data.frame(file_list = dir(path = "C:/Users/Vinicius/Desktop/data/morada/24-01/dendrometers")) %>%
mutate(file_path = paste("C:/Users/Vinicius/Desktop/data/morada/24-01/dendrometers", file_list, sep = "/"),
location = "Morada do Sol")
df_files_am <- data.frame(file_list = dir(path = "C:/Users/Vinicius/Desktop/data/aldeia/24-01/dendrometers")) %>%
mutate(file_path = paste("C:/Users/Vinicius/Desktop/data/aldeia/24-01/dendrometers", file_list, sep = "/"),
location = "Aldeia Multiétnica")
df_files_all <- rbind(df_files_ms, df_files_am)
# Empty data frame to receive the data from the for loop
logger_data <- data.frame()
for (i in df_files_ms$file_path) {
file_path <- i  # Adicionando essa linha para definir o caminho do arquivo atual
data_temp <- read.csv(file_path) %>%
rename(date = datetime,
internalT = internalT_moC,
battery = battery_mV,
sen0_adc24 = 4, sen1_adc24 = 5, sen2_adc24 = 6, sen3_adc24 = 7) %>%
mutate(id_logger = substr(i, 58, 62),
date = as.POSIXct(date, tz = "GMT", format = "%y/%m/%d %H:%M:%S"))
logger_data <- rbind(logger_data, data_temp)  # Adicionando os dados temporários ao quadro de dados principal
}
unique(df_long$id_port)
df_long %>%
mutate(logger_tree_id = paste(id_tree, id_logger, location, sep = " - ")) %>%
ggplot(aes(x = date, y = change_index_abs, col = id_tree)) +
geom_line() +
facet_wrap(~logger_tree_id, ncol = 4, scales = "free") +
theme_classic()+
ylab("Growth deviation from mean (um)")+
xlab("")+
theme(legend.position = "none")
## Relative dendrometer changes (% change compared to mean)
df_long %>%
mutate(logger_tree_id = paste(id_logger, id_tree, sep = " - ")) %>%
ggplot(aes(x = date, y = change_index_rel, col = location)) +
geom_line() +
facet_wrap(~logger_tree_id) +
theme_classic()+
ylab("Relative growth changes")+
xlab("")+
theme(legend.position = "top",
legend.background = element_blank())
## Internal temp along the days
df_long %>%
mutate(logger_tree_id = paste(id_logger, id_tree, sep = " - ")) %>%
ggplot(aes(x = date, y = internalT/1000)) +
geom_line() +
ylab("Internal T (ºC)")+
facet_wrap(~logger_tree_id) +
theme_classic()
## Internal temp versus relative growth changes (should give linear corr for empty ports)
df_long %>%
mutate(logger_tree_id = paste(id_logger, id_tree, sep = " - ")) %>%
ggplot(aes(x = internalT/1000, y = change_index_rel, col = location)) +
geom_point(size = 0.8) +
ylab("Relative growth changes")+
xlab("Internal T (ºC)")+
facet_wrap(~logger_tree_id) +
theme_classic()
df_long %>%
mutate(logger_tree_id = paste(id_tree, id_logger, location, sep = " - ")) %>%
ggplot(aes(x = date, y = change_index_abs, col = id_tree)) +
geom_line() +
facet_wrap(~logger_tree_id, ncol = 4, scales = "free") +
theme_classic()+
ylab("Growth deviation from mean (um)")+
xlab("")+
theme(legend.position = "none")
df_long <- logger_data %>%
relocate(id_logger) %>%
pivot_longer(-c("id_logger", "date", "internalT", "battery"),
names_to = "id_port",
values_to = "dend_value",
values_drop_na = TRUE) %>%
mutate(data_mv    = dend_value * (3300 / 2^23),
Resistance = data_mv / current / 1000,
Position   = totalTravel - (Resistance * conversionFactor)) %>% #inverse?
left_join(logger_list) %>%
separate(tree_info, into = c("id_tree", "location"), sep = "_") %>%
mutate(logger_port = paste(id_logger, id_port, sep = "_")) %>%
arrange(id_logger, id_port, date)
str(df_long)
## Calculate the mean position of each dendrometer
mean_pos <- df_long %>%
group_by(logger_port) %>%
summarize(mean_pos = mean(Position, na.rm = T))
## Use mean position to calculate relative changes and absolute deviations
df_long <- df_long %>%
left_join(mean_pos) %>%
mutate(change_index_abs = Position - mean_pos,
change_index_rel = Position / mean_pos)
## Criate the id overview
df_long <- df_long %>%
mutate(
den = substr(id_port, 1,4))
df_long <- df_long %>%
mutate(df_overview = paste(id_tree, location, den, sep = "_"))
df_long %>%
mutate(logger_tree_id = paste(id_tree, id_logger, location, sep = " - ")) %>%
ggplot(aes(x = date, y = change_index_abs, col = id_tree)) +
geom_line() +
facet_wrap(~logger_tree_id, ncol = 4, scales = "free") +
theme_classic()+
ylab("Growth deviation from mean (um)")+
xlab("")+
theme(legend.position = "none")
for (i in df_files_ms$file_path) {
file_path <- i  # Adicionando essa linha para definir o caminho do arquivo atual
data_temp <- read.csv(file_path) %>%
rename(date = datetime,
internalT = internalT_moC,
battery = battery_mV,
sen0_adc24 = 4, sen1_adc24 = 5, sen2_adc24 = 6, sen3_adc24 = 7) %>%
mutate(id_logger = substr(i, 58, 62),
date = as.POSIXct(date, tz = "GMT", format = "%y/%m/%d %H:%M:%S"))
logger_data <- rbind(logger_data, data_temp)  # Adicionando os dados temporários ao quadro de dados principal
}
unique(df_long$id_port)
df_long <- logger_data %>%
relocate(id_logger) %>%
pivot_longer(-c("id_logger", "date", "internalT", "battery"),
names_to = "id_port",
values_to = "dend_value",
values_drop_na = TRUE) %>%
mutate(data_mv    = dend_value * (3300 / 2^23),
Resistance = data_mv / current / 1000,
Position   = totalTravel - (Resistance * conversionFactor)) %>% #inverse?
left_join(logger_list) %>%
separate(tree_info, into = c("id_tree", "location"), sep = "_") %>%
mutate(logger_port = paste(id_logger, id_port, sep = "_")) %>%
arrange(id_logger, id_port, date)
str(df_long)
## Calculate the mean position of each dendrometer
mean_pos <- df_long %>%
group_by(logger_port) %>%
summarize(mean_pos = mean(Position, na.rm = T))
## Use mean position to calculate relative changes and absolute deviations
df_long <- df_long %>%
left_join(mean_pos) %>%
mutate(change_index_abs = Position - mean_pos,
change_index_rel = Position / mean_pos)
## Criate the id overview
df_long <- df_long %>%
mutate(
den = substr(id_port, 1,4))
df_long <- df_long %>%
mutate(df_overview = paste(id_tree, location, den, sep = "_"))
df_long %>%
mutate(logger_tree_id = paste(id_tree, id_logger, location, sep = " - ")) %>%
ggplot(aes(x = date, y = change_index_abs, col = id_tree)) +
geom_line() +
facet_wrap(~logger_tree_id, ncol = 4, scales = "free") +
theme_classic()+
ylab("Growth deviation from mean (um)")+
xlab("")+
theme(legend.position = "none")
logger_list
# Create file list of the data logger files (per logger + date)
df_files_ms <- data.frame(file_list = dir(path = "C:/Users/Vinicius/Desktop/data/morada/24-01/dendrometers")) %>%
mutate(file_path = paste("C:/Users/Vinicius/Desktop/data/morada/24-01/dendrometers", file_list, sep = "/"),
location = "Morada do Sol")
df_files_ms
df_files_all
# Empty data frame to receive the data from the for loop
logger_data <- data.frame()
# Empty data frame to receive the data from the for loop
logger_data <- data.frame()
for (i in df_files_ms$file_path) {
file_path <- i  # Adicionando essa linha para definir o caminho do arquivo atual
data_temp <- read.csv(file_path) %>%
rename(date = datetime,
internalT = internalT_moC,
battery = battery_mV,
sen0_adc24 = 4, sen1_adc24 = 5, sen2_adc24 = 6, sen3_adc24 = 7) %>%
mutate(id_logger = substr(i, 58, 62),
date = as.POSIXct(date, tz = "GMT", format = "%y/%m/%d %H:%M:%S"))
logger_data <- rbind(logger_data, data_temp)  # Adicionando os dados temporários ao quadro de dados principal
}
View(logger_data)
View(df_long)
## Relative dendrometer changes (% change compared to mean)
df_long %>%
mutate(logger_tree_id = paste(id_logger, id_tree, sep = " - ")) %>%
ggplot(aes(x = date, y = change_index_rel, col = location)) +
geom_line() +
facet_wrap(~logger_tree_id) +
theme_classic()+
ylab("Relative growth changes")+
xlab("")+
theme(legend.position = "top",
legend.background = element_blank())
## Internal temp along the days
df_long %>%
mutate(logger_tree_id = paste(id_logger, id_tree, sep = " - ")) %>%
ggplot(aes(x = date, y = internalT/1000)) +
geom_line() +
ylab("Internal T (ºC)")+
facet_wrap(~logger_tree_id) +
theme_classic()
## Internal temp versus relative growth changes (should give linear corr for empty ports)
df_long %>%
mutate(logger_tree_id = paste(id_logger, id_tree, sep = " - ")) %>%
ggplot(aes(x = internalT/1000, y = change_index_rel, col = location)) +
geom_point(size = 0.8) +
ylab("Relative growth changes")+
xlab("Internal T (ºC)")+
facet_wrap(~logger_tree_id) +
theme_classic()
df_long %>%
mutate(logger_tree_id = paste(id_tree, id_logger, location, sep = " - ")) %>%
ggplot(aes(x = date, y = change_index_abs, col = id_tree)) +
geom_line() +
facet_wrap(~logger_tree_id, ncol = 4, scales = "free") +
theme_classic()+
ylab("Growth deviation from mean (um)")+
xlab("")+
theme(legend.position = "none")
